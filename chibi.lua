chibi208 = {
    faction_name = {
        "3k_main_faction_cao_cao",
        "3k_main_faction_liu_bei",
        "3k_main_faction_sun_jian",
        "3k_main_faction_shi_xie",
        "3k_main_faction_liu_yan",
        "3k_main_faction_dong_zhuo",
        "3k_main_faction_zhang_lu",
        "3k_main_faction_ma_teng",
        "3k_main_faction_han_sui",
        "3k_main_faction_gongsun_du",
        "3k_dlc05_faction_zang_ba",
        "3k_main_faction_yellow_turban_rebels",
        "3k_dlc06_faction_nanman_king_meng_huo"
    },
    region208 = {
        --曹操
        [1] = { "3k_main_taiyuan_capital", "3k_main_taiyuan_resource_1", "3k_main_taiyuan_resource_2",
            "3k_main_daijun_capital", "3k_main_daijun_resource_1",
            "3k_main_hedong_capital", "3k_main_hedong_resource_1", "3k_dlc06_hedong_resource_2",
            "3k_main_shangdang_capital", "3k_main_shangdang_resource_1", "3k_dlc06_shangdang_resource_2",
            "3k_main_weijun_capital", "3k_main_weijun_resource_1",
            "3k_main_henei_capital", "3k_main_henei_resource_1",
            "3k_main_pingyuan_capital", "3k_main_pingyuan_resource_1",
            "3k_main_zhongshan_capital", "3k_main_zhongshan_resource_1",
            "3k_main_bohai_capital", "3k_main_bohai_resource_1",
            "3k_main_anping_capital", "3k_main_anping_resource_1",
            "3k_main_yingchuan_capital", "3k_main_yingchuan_resource_1", "3k_main_luoyang_resource_1",
            "3k_main_chenjun_capital", "3k_main_chenjun_resource_1", "3k_main_chenjun_resource_2",
            "3k_main_yangzhou_resource_2", "3k_main_yangzhou_resource_1", "3k_main_chenjun_resource_3",
            "3k_main_nanyang_capital", "3k_main_nanyang_resource_1",
            "3k_main_xiangyang_capital", "3k_main_xiangyang_resource_1",
            "3k_main_lujiang_capital", "3k_main_yangzhou_capital",
            "3k_main_guangling_capital", "3k_main_guangling_resource_1",
            "3k_main_jingzhou_capital", "3k_main_jingzhou_resource_1", "3k_main_yangzhou_resource_3",
            "3k_dlc06_hulao_pass", "3k_dlc06_gu_pass", "3k_dlc06_qi_pass", "3k_dlc06_hangu_pass" },
        --刘备
        [2] = {
            "3k_main_changsha_capital", "3k_main_changsha_resource_1", "3k_main_changsha_resource_2",
            "3k_main_changsha_resource_3", "3k_main_badong_resource_2", "3k_main_cangwu_resource_1",
            "3k_main_lingling_capital", "3k_main_lingling_resource_1", "3k_main_lingling_resource_2",
            "3k_main_wuling_capital", "3k_main_wuling_resource_1", "3k_main_wuling_resource_2", },
        --孙权
        [3] = { "3k_main_lujiang_resource_1", "3k_main_lujiang_resource_2", "3k_main_guangling_resource_2",
            "3k_main_jianye_capital", "3k_main_jianye_resource_1", "3k_main_jianye_resource_2",
            "3k_main_xindu_capital", "3k_main_xindu_resource_1", "3k_main_xindu_resource_2",
            "3k_main_kuaiji_capital", "3k_main_kuaiji_resource_1", "3k_main_kuaiji_resource_2",
            "3k_main_jianan_capital", "3k_main_jianan_resource_1", "3k_main_jianan_resource_2",

            "3k_main_poyang_capital", "3k_main_poyang_resource_1", "3k_main_poyang_resource_2",
            "3k_main_poyang_resource_3",
            "3k_main_yuzhang_capital", "3k_main_yuzhang_resource_1", "3k_main_yuzhang_resource_2",
            "3k_main_luling_capital", "3k_main_luling_resource_1", },
        --士燮
        [4] = { "3k_main_jiaozhi_capital", "3k_main_jiaozhi_resource_1",
            "3k_main_yulin_capital", "3k_main_yulin_resource_1", "3k_main_yulin_resource_2",
            "3k_main_hepu_capital", "3k_main_hepu_resource_1", "3k_main_hepu_resource_2",
            "3k_dlc06_jiuzhen_capital", "3k_dlc06_jiuzhen_resource_1",
            "3k_main_nanhai_capital", "3k_main_nanhai_resource_1", "3k_main_nanhai_resource_2",
            "3k_main_gaoliang_capital", "3k_main_gaoliang_resource_1",
            "3k_main_cangwu_capital", "3k_main_cangwu_resource_2", "3k_main_cangwu_resource_3", },
        --刘璋
        [5] = { "3k_main_chengdu_capital", "3k_main_chengdu_resource_1", "3k_main_chengdu_resource_2",
            "3k_main_chengdu_resource_3",
            "3k_main_baxi_capital", "3k_main_baxi_resource_2", "3k_main_jiangyang_resource_3",
            "3k_main_jiangyang_capital", "3k_main_jiangyang_resource_1", "3k_main_jiangyang_resource_2",
            "3k_main_bajun_capital", "3k_main_bajun_resource_1", "3k_main_shangyong_resource_2",
            "3k_main_fuling_capital", "3k_main_fuling_resource_1",
            "3k_main_badong_capital", "3k_main_badong_resource_1", "3k_dlc06_kui_pass" },
        --董卓
        [6] = { "3k_main_changan_capital", "3k_main_changan_resource_1", "3k_main_hanzhong_resource_1",
            "3k_dlc06_san_pass", "3k_dlc06_wu_pass", "3k_dlc06_tong_pass" },
        --张鲁
        [7] = { "3k_main_hanzhong_capital", "3k_main_shangyong_capital", "3k_main_shangyong_resource_1",
            "3k_main_baxi_resource_1", "3k_dlc06_jiameng_pass" },
        --马腾
        [8] = { "3k_main_wudu_capital", "3k_main_wudu_resource_1", "3k_main_wudu_resource_2",
            "3k_main_wuwei_capital", "3k_main_wuwei_resource_1", "3k_main_wuwei_resource_2",
            "3k_main_jincheng_capital", "3k_main_jincheng_resource_1", "3k_main_jincheng_resource_2" },
        --韩遂
        [9] = { "3k_main_shoufang_capital", "3k_main_shoufang_resource_1", "3k_main_shoufang_resource_2",
            "3k_main_shoufang_resource_3",
            "3k_main_anding_capital", "3k_main_anding_resource_1", "3k_main_anding_resource_2",
            "3k_main_anding_resource_3",
            "3k_main_xihe_capital", "3k_main_xihe_resource_1" },
        --公孙度
        [10] = {
            "3k_main_youbeiping_capital", "3k_main_youbeiping_resource_1",
            "3k_main_youzhou_capital", "3k_main_youzhou_resource_1",
            "3k_dlc06_liaodong_capital", "3k_dlc06_liaodong_resource_1",
            "3k_main_yu_capital", "3k_main_yu_resource_1", },
        --臧霸
        [11] = { "3k_main_dongjun_capital", "3k_main_dongjun_resource_1", "3k_main_penchang_resource_1",
            "3k_main_taishan_capital", "3k_main_taishan_resource_1", "3k_main_penchang_capital",
            "3k_main_beihai_capital", "3k_main_beihai_resource_1",
            "3k_main_donglai_capital", "3k_main_donglai_resource_1",
            "3k_main_langye_capital", "3k_main_langye_resource_1", "3k_main_langye_resource_2",
            "3k_dlc06_xiapi_capital", "3k_dlc06_xiapi_resource_1",
            "3k_main_donghai_capital", "3k_main_donghai_resource_1" },
        --何仪
        [12] = { "3k_main_runan_capital", "3k_main_runan_resource_1",
            "3k_main_jiangxia_capital", "3k_main_jiangxia_resource_1", },
        --孟获
        [13] = {
            "3k_main_zangke_capital", "3k_main_zangke_resource_1", "3k_main_zangke_resource_2",
            "3k_main_jiaozhi_resource_2", "3k_dlc06_jiaozhi_resource_3",
            "3k_dlc06_yunnan_capital", "3k_dlc06_yunnan_resource_1", "3k_dlc06_yunnan_resource_2",
            "3k_dlc06_yongchang_capital", "3k_dlc06_yongchang_resource_1",
            "3k_main_jianning_capital", "3k_main_jianning_resource_1",
            "3k_main_jianning_resource_2", "3k_dlc06_jianning_resource_3" },
    },
    capital = {
        --曹操
        "3k_main_weijun_capital",
        --刘备
        "3k_main_changsha_capital",
        --孙权
        "3k_main_jianye_capital",
        --士燮
        "3k_main_jiaozhi_capital",
        --刘璋
        "3k_main_chengdu_capital",
        --董卓
        "3k_main_changan_capital",
        --张鲁
        "3k_main_hanzhong_capital",
        --马腾
        "3k_main_wudu_capital",
        --韩遂
        "3k_main_shoufang_capital",
        --公孙度
        "3k_dlc06_liaodong_capital",
        --臧霸
        "3k_main_dongjun_capital",
        --何仪
        "3k_main_runan_capital",
        --孟获
        "3k_main_jianning_capital",
    },
    character = {
        --曹操
        [1] = {
            "3k_main_template_historical_cao_ang_hero_wood",
            "3k_main_template_historical_cao_chun_hero_fire",
            "3k_main_template_historical_cao_hong_hero_wood",
            "3k_main_template_historical_cao_pi_hero_earth",
            "3k_main_template_historical_cao_ren_hero_earth",
            "3k_main_template_historical_cao_rui_hero_earch",
            "3k_main_template_historical_cao_shuang_hero_wood",
            "3k_main_template_historical_cao_xiu_hero_fire",
            "3k_main_template_historical_cao_zhen_hero_earth",
            "3k_main_template_historical_cao_zhi_hero_water",
            "3k_main_template_historical_dian_wei_hero_wood",
            "3k_main_template_historical_xu_chu_hero_wood",
            "3k_main_template_historical_guo_jia_hero_water",
            "3k_main_template_historical_guonv_wang_hero_earth",
            "3k_main_template_historical_cao_jie_hero_water",
            "3k_main_template_historical_xiahou_ba_hero_wood",
            "3k_main_template_historical_xiahou_dun_hero_wood",
            "3k_main_template_historical_xiahou_shang_hero_fire",
            "3k_main_template_historical_xiahou_yuan_hero_fire",
            "3k_main_template_historical_yue_jin_hero_metal",
            "3k_main_template_historical_xu_yi_hero_earth",
            "3k_main_template_historical_cheng_yu_hero_water",
            "3k_main_template_historical_yu_jin_hero_metal",
            "3k_main_template_historical_mao_jie_hero_water",
            "3k_main_template_historical_xun_yu_hero_water",
            "3k_main_template_historical_xun_you_hero_water",
            "3k_main_template_historical_yang_xiu_hero_water",
            "3k_main_template_historical_mi_heng_hero_water",
            "3k_main_template_historical_sima_yi_hero_water",
            "3k_main_template_historical_zhang_he_hero_metal",
            "3k_main_template_historical_zhang_xiu_hero_metal",
            "3k_main_template_historical_zhang_liao_hero_metal",
            "3k_main_template_historical_xu_huang_hero_metal",
            "3k_main_template_historical_qian_zhao_hero_metal",
            "3k_main_template_historical_li_dian_hero_metal",
            "3k_main_template_historical_bu_zhi_hero_water",
            "3k_main_template_historical_man_chong_hero_water",
        },
        --刘备
        [2] = {
            "3k_main_template_historical_guan_yu_hero_wood",
            "3k_main_template_historical_zhang_fei_hero_fire",
            "3k_main_template_historical_zhao_yun_hero_metal",
            "3k_main_template_historical_huang_zhong_hero_metal",
            "3k_main_template_historical_xu_shu_hero_water",
            "3k_main_template_historical_pang_tong_hero_water",
            "3k_main_template_historical_zhuge_liang_hero_water",
            "3k_main_template_historical_huangyue_ying_hero_wood",
            "3k_main_template_historical_guan_xing_hero_wood",
            "3k_main_template_historical_guan_ping_hero_fire",
            "3k_main_template_historical_guan_suo_hero_earth",
            "3k_main_template_historical_guanyin_ping_hero_wood",
            "3k_main_template_historical_zhang_bao_hero_metal",
            "3k_main_template_historical_zhangxing_cai_hero_metal",
            "3k_main_template_historical_liu_feng_hero_fire",
            "3k_main_template_historical_liu_shan_hero_earth",
            "3k_main_template_historical_liu_zhan_hero_wood",
            "3k_main_template_historical_zhuge_zhan_hero_earth",
            "3k_main_template_historical_zhuge_jun_hero_water",
            "3k_main_template_historical_chen_dao_hero_wood",
            "3k_main_template_historical_xiahou_ji_hero_water",
            "3k_main_template_historical_mifu_ren_hero_earth",
            "3k_main_template_historical_zhou_cang_hero_fire",
            "3k_main_template_historical_liao_hua_hero_wood",
            "3k_main_template_historical_wu_xian_hero_water",
            "3k_main_template_historical_ma_su_hero_water",
            "3k_main_template_historical_wei_yan_hero_wood",
            "3k_main_template_historical_zhao_tong_hero_wood",
            "3k_main_template_historical_zhao_guang_hero_wood",
        },
        --孙权
        [3] = {
            "3k_main_template_historical_da_qiao_hero_earth",
            "3k_main_template_historical_xiao_qiao_hero_water",
            "3k_main_template_historical_lu_xun_hero_water",
            "3k_main_template_historical_lu_kang_hero_earth",
            "3k_main_template_historical_sun_ru_hero_fire",
            "3k_main_template_historical_lu_su_hero_water",
            "3k_main_template_historical_huang_gai_hero_fire",
            "3k_main_template_historical_zhou_tai_hero_fire",
            "3k_main_template_historical_han_dang_hero_wood",
            "3k_main_template_historical_cheng_pu_hero_metal",
            "3k_main_template_historical_gan_ning_hero_fire",
            "3k_main_template_historical_ling_tong_hero_wood",
            "3k_main_template_historical_zhu_huan_hero_wood",
            "3k_main_template_historical_zhu_yi_hero_metal",
            "3k_main_template_historical_zhu_ran_hero_fire",
            "3k_main_template_historical_zhu_zhi_hero_metal",
            "3k_main_template_historical_lv_meng_hero_metal",
            "3k_main_template_historical_xu_sheng_hero_fire",
            "3k_main_template_historical_ding_feng_hero_metal",
            "3k_main_template_historical_sun_xiu_hero_water",
            "3k_main_template_historical_zhou_yu_hero_water",
            "3k_main_template_historical_zhuge_jin_hero_water",
            "3k_main_template_historical_zhuge_ke_hero_earth",
            "3k_main_template_historical_chen_wu_hero_metal",
            "3k_main_template_historical_yu_ji_hero_earth",
            "3k_main_template_historical_jiang_qin_hero_fire",
            "3k_main_template_historical_wu_jing_hero_fire",
            "3k_main_template_historical_he_qi_hero_fire",
            "3k_main_template_historical_taishi_ci_hero_metal",
            "3k_main_template_historical_zhang_zhao_hero_water",
            "3k_main_template_historical_zhang_hong_hero_water",
            "3k_main_template_historical_lv_dai_hero_fire",
        },
        --士燮
        [4] = {
            "3k_main_template_historical_shi_wu_hero_fire",
            "3k_main_template_historical_shi_yi_hero_metal",
            "3k_main_template_historical_shi_hui_hero_earth",
            "3k_main_template_historical_shi_huang_hero_earth",
            "3k_main_template_historical_shi_kuang_hero_fire",
            "3k_main_template_historical_zhao_ou_hero_wood",
            "3k_main_template_historical_wu_yan_hero_wood",
        },
        --刘璋
        [5] = {
            "3k_main_template_historical_fei_yi_hero_water",
            "3k_main_template_historical_dong_yun_hero_water",
            "3k_main_template_historical_deng_xian_hero_wood",
            "3k_main_template_historical_yan_yan_hero_wood",
            "3k_main_template_historical_wu_yi_hero_fire",
            "3k_main_template_historical_zhang_ren_hero_metal",
            "3k_main_template_historical_zhang_yi_hero_metal",
            "3k_main_template_historical_leng_bao_hero_metal",
            "3k_main_template_historical_dong_he_hero_water",
            "3k_main_template_historical_fa_zheng_hero_water",
            "3k_main_template_historical_li_hui_hero_water",
            "3k_main_template_historical_zhang_song_hero_water",
            "3k_main_template_historical_huang_quan_hero_earth",
            "3k_main_template_historical_li_yan_hero_fire",
            "3k_main_template_historical_wang_ping_hero_fire",
            "3k_main_template_historical_zhang_yi_hero_wood",
        },

        --董卓
        [6] = {
            "3k_main_template_historical_dong_bai_hero_metal",
            "3k_main_template_historical_dong_zhuo_hero_fire",
            "3k_main_template_historical_lv_bu_hero_fire",
            "3k_main_template_historical_diao_chan_hero_water",
            "3k_main_template_historical_gao_shun_hero_fire",
            "3k_main_template_historical_zhang_liao_hero_metal",
            "3k_main_template_historical_song_xian_hero_metal",
            "3k_main_template_historical_cao_xing_hero_wood",
            "3k_main_template_historical_wei_xu_hero_fire",
            "3k_main_template_historical_dufu_ren_hero_water",
            "3k_main_template_historical_jia_xu_hero_water",
            "3k_main_template_historical_li_ru_hero_earth",
        },
        --张鲁
        [7] = {
            "3k_main_template_historical_zhangying_qi_hero_earth",
            "3k_main_template_historical_zhangying_qi_hero_water",
        },
        --马腾
        [8] = {
            "3k_main_template_historical_ma_chao_hero_fire",
            "3k_main_template_historical_ma_dai_hero_fire",
            "3k_main_template_historical_mayun_lu_hero_fire",
            "3k_main_template_historical_mayun_lu_hero_wood",
            "3k_main_template_historical_pang_de_hero_wood",
        },
        --韩遂
        [9] = {
            "3k_main_template_historical_han_yue_hero_metal",
        },
        --公孙度
        [10] = {
            "3k_main_template_historical_gongsun_kang_hero_earth",
        },
        --臧霸
        [11] = {
            "3k_main_template_historical_lu_zheng_hero_water",
        },
        --何仪
        [12] = {
            "3k_main_template_historical__hero_",
        },
        --孟获
        [13] = {
            "3k_main_template_historical_meng_jie_hero",
        },
    },
    useless_region = { "3k_main_luoyang_capital",
        "3k_main_yizhou_island_capital", "3k_main_yizhou_island_resource_1",
        "3k_main_yanmen_capital", "3k_main_yanmen_resource_1",
        "3k_main_tongan_capital", "3k_main_tongan_resource_1",
        "3k_main_dongou_capital", "3k_main_dongou_resource_1",
    }
}

cm:add_first_tick_callback(function() chibi208:Initialise() end);
function chibi208:Initialise()
    -- 如果已触发过，不执行任何操作
    if cm:get_saved_value("Chibi208_triggered") then
        return
    end
    core:add_listener("Chibi208EventTrigger", "FactionTurnStart",
        function(context) return context:query_model():turn_number() == 1; end,
        function(context)
            cm:trigger_dilemma(context:faction():name(), "chibi_dilemma", true);
        end
        , false);
    -- 监听玩家的选择
    core:add_listener(
        "DilemmaChoiceListener",  -- 监听器名称
        "DilemmaChoiceMadeEvent", -- 事件类型：难题选择事件
        function(context)
            return context:dilemma() == "chibi_dilemma"
        end,
        function(context)
            local choice = context:choice() -- 获取玩家选择的选项
            -- 玩家选择了第一个选项（True）
            if choice == 0 then
                self:chibi()
            end
        end,
        false -- 事件触发后不会继续监听
    )
    -- 标记脚本已触发
    cm:set_saved_value("Chibi208_triggered", true)
end

function chibi208:chibi()
    ModLog("xiang ruin useless region")
    --毁灭无用地区
    for i, region_name in ipairs(self.useless_region) do
        cm:query_model():world():region_manager():region_list():foreach(function(region)
            if region:name() == region_name then
                if region:can_raze_and_abandon_settlement_without_attacking() then
                    cm:modify_model():get_modify_region(region):raze_and_abandon_settlement_without_attacking()
                end
            end
        end)
    end
    ModLog("xiang choose faction")
    --选择派系
    self:choose_faction()
    ModLog("xiang left one faction")
    --留下唯一派系
    self:left_one_faction()
    ModLog("xiang set region")
    --设置领地
    for i, faction_name in ipairs(self.faction_name) do
        self:set_faction(faction_name, i)
    end
    ModLog("xiang set character")
    --设置特殊武将
    --self:set_character()
    ModLog("xiang clean faction")
    --清除无用派系
    self:clean_faction()
    ModLog("xiang peace")
    --设置外交
    self:diplomacy_peace()
    ModLog("xiang move army")
    self:move_army()
    --给玩家10万
    ModLog("xiang give player money")
    cm:modify_faction(cm:get_human_factions()[1]):increase_treasury(100000)

    self:RemoveMission()
    self:reset_camera()

    --5回合后开战
end

function chibi208:choose_faction()
    --寻找现存的匪盗
    --臧霸
    if cm:query_faction("3k_dlc05_faction_zang_ba") then
    elseif cm:query_faction("3k_main_faction_zheng_jiang") then
        self.faction_name[11] = "3k_main_faction_zheng_jiang"
    elseif cm:query_faction("3k_main_faction_zhang_yan") then
        self.faction_name[11] = "3k_main_faction_zhang_yan"
    elseif cm:query_faction("3k_dlc05_faction_white_tiger_yan") then
        self.faction_name[11] = "3k_dlc05_faction_white_tiger_yan"
    end
    --寻找现存的黄巾
    --何仪
    if cm:query_faction("3k_main_faction_yellow_turban_rebels") then
        --黄邵
    elseif cm:query_faction("3k_main_faction_yellow_turban_taishan") then
        self.faction_name[12] = "3k_main_faction_yellow_turban_taishan"
        --龚都
    elseif cm:query_faction("3k_main_faction_yellow_turban_anding") then
        self.faction_name[12] = "3k_main_faction_yellow_turban_anding"
        --张角
    elseif cm:query_faction("3k_dlc04_faction_zhang_jue") then
        self.faction_name[12] = "3k_dlc04_faction_zhang_jue"
        --张角
    elseif cm:query_faction("3k_dlc04_faction_zhang_liang") then
        self.faction_name[12] = "3k_dlc04_faction_zhang_liang"
        --张角
    elseif cm:query_faction("3k_dlc04_faction_zhang_bao") then
        self.faction_name[12] = "3k_dlc04_faction_zhang_bao"
    end


    --判断是孙策还是孙坚
    if cm:query_faction("3k_main_faction_sun_jian") then
    else
        self.faction_name[3] = "3k_dlc05_faction_sun_ce"
    end
    --判断董卓还是张猛
    if cm:query_faction("3k_dlc07_faction_zhang_meng") then
        self.faction_name[6] = "3k_dlc07_faction_zhang_meng"
    end
    --判断张鲁
    if cm:query_faction("3k_main_faction_zhang_lu") then
    else
        self.faction_name[7] = "3k_dlc07_faction_zhang_lu"
    end
    --判断公孙度还是公孙瓒
    if cm:query_faction("3k_main_faction_gongsun_du") then
    else
        self.faction_name[10] = "3k_main_faction_gongsun_zan"
    end
    --判断拓跋力微还是韩遂
    if cm:query_faction("ngc_custom_faction_tuoba_liwei") then
        self.faction_name[9] = "ngc_custom_faction_tuoba_liwei"
    else
        self.faction_name[9] = "3k_main_faction_han_sui"
    end


    --判断玩家使用汉、匪盗、黄巾、南蛮
    local player_factions = cm:query_faction(cm:get_human_factions()[1])
    if player_factions:subculture() == "3k_main_chinese" and not table.contains(self.faction_name, player_factions:name()) then
        self.faction_name[6] = player_factions:name()
    end
    --如果玩家使用匪盗
    if player_factions:subculture() == "3k_dlc05_subculture_bandits" then
        self.faction_name[11] = player_factions:name()
    end
    --如果玩家使用黄巾
    if player_factions:subculture() == "3k_main_subculture_yellow_turban" then
        self.faction_name[12] = player_factions:name()
    end
    --如果玩家使用南蛮
    if player_factions:culture() == "3k_dlc06_barbarian" then
        self.faction_name[13] = player_factions:name()
    end
end

function chibi208:left_one_faction()
    cm:query_model():world():faction_list():foreach(function(filter_faction)
        if filter_faction:subculture() == "3k_dlc05_subculture_bandits" then
            cm:modify_faction(self.faction_name[11]):make_confederation_with(filter_faction)
        end
    end)
    cm:query_model():world():faction_list():foreach(function(filter_faction)
        if filter_faction:subculture() == "3k_main_subculture_yellow_turban" then
            cm:modify_faction(self.faction_name[12]):make_confederation_with(filter_faction)
        end
    end)
    cm:query_model():world():faction_list():foreach(function(filter_faction)
        if filter_faction:culture() == "3k_dlc06_barbarian" then
            cm:modify_faction(self.faction_name[13]):make_confederation_with(filter_faction)
        end
    end)
end

function chibi208:set_faction(faction_name, number)
    -- 检查派系是否存在
    local faction = cm:query_faction(faction_name)
    if faction and not faction:is_null_interface() then
        --给地盘
        for j, region in ipairs(self.region208[number]) do
            cm:modify_region(region):settlement_gifted_as_if_by_payload(cm:modify_faction(faction_name))
        end
        --设置都城
        cm:modify_faction(faction_name):make_region_capital(cm:query_region(self.capital[number]))
        --给钱
        if not cm:query_faction(faction_name):is_human() then
            cm:modify_faction(faction_name):increase_treasury(1000000)
        end
    end
end

function chibi208:set_character()
    for i, faction_name in ipairs(self.faction_name) do
        for j, character in ipairs(self.character[i]) do
            if not cm:query_character(character):is_null_interface() then
                cm:modify_character(cm:query_character(character)):move_to_faction_and_make_recruited(
                    faction_name)
            else
                ModLog("cant find hero:")
                ModLog(character)
            end
        end
    end
end

function chibi208:clean_faction()
    -- 打乱列表顺序
    local n = #self.faction_name
    for i = n, 2, -1 do
        local j = cm:random_int(1, i)
        self.faction_name[i], self.faction_name[j] = self.faction_name[j], self.faction_name[i]
    end
    local flag = #self.faction_name - 3
    ModLog("xiang random faction list")
    cm:query_model():world():character_list():foreach(function(character)
        if not character:is_null_interface() and not character:is_dead() then
            if character:faction():region_list():num_items() == 0 then
                -- 将角色分配给派系
                cm:modify_character(character):move_to_faction_and_make_recruited(self.faction_name[flag])
                flag = flag - 1
                if flag <= 0 then
                    flag = #self.faction_name
                end
            end
        end
    end)
end

function chibi208:move_army()
    -- 遍历所有派系
    cm:query_model():world():faction_list():foreach(function(filter_faction)
        -- 判断派系是否有领土
        if filter_faction:region_list():num_items() > 0 then
            local query_capital = filter_faction:capital_region()
            -- 遍历派系的军队
            for i = 0, filter_faction:military_force_list():num_items() - 1 do
                local filter_force = filter_faction:military_force_list():item_at(i)
                local region_x = query_capital:settlement():logical_position_x() + math.random(1200) / 100 - 6
                local region_y = query_capital:settlement():logical_position_y() + math.random(1200) / 100 - 6
                if not misc:is_transient_character(filter_force:general_character()) then
                    local force_general = filter_force:general_character()
                    local found_pos, x, y = filter_faction:get_valid_spawn_location_near(region_x, region_y, 10, false)
                    if not found_pos then
                        found_pos, x, y = filter_faction:get_valid_spawn_location_in_region(query_capital:name(), false)
                    end
                    if found_pos then
                        cm:modify_character(force_general):teleport_to(x, y)
                    end
                end
            end
        end
    end)
end

function chibi208:reset_camera()
    local query_settlement = cm:query_faction(cm:get_human_factions()[1]):capital_region():settlement();
    local x, y, d, b, h = cm:get_camera_position();
    local new_capital_x = query_settlement:display_position_x();
    local new_capital_y = query_settlement:display_position_y();
    local duration = 0.2 * distance_squared(x, y, new_capital_x, new_capital_y);
    duration = math.min(duration, 5);
    if duration > 0 then
        cm:scroll_camera_from_current(duration, true, { new_capital_x, new_capital_y, 8, b, 10 });
    end;
end

function chibi208:diplomacy_peace()
    -- 遍历所有派系并执行和平处理
    cm:query_model():world():faction_list():foreach(function(filter_faction1)
        if not filter_faction1:is_dead() then
            cm:query_model():world():faction_list():foreach(function(filter_faction2)
                if not filter_faction2:is_dead() and filter_faction1:name() ~= filter_faction2:name() then
                    if diplomacy_manager:is_at_war_with(filter_faction1:name(), filter_faction2:name()) then
                        diplomacy_manager:apply_automatic_deal_between_factions(filter_faction1:name(),
                            filter_faction2:name(), "data_defined_situation_peace", false)
                    end
                end
            end)
        end
    end)
end
function chibi208:set_diplomacy()
    --组建联军

        diplomacy_manager:apply_automatic_deal_between_factions(filter_faction1:name(),
            filter_faction2:name(), "data_defined_situation_peace", false)

    --宣战
    diplomacy_manager:apply_automatic_deal_between_factions(filter_faction1:name(),
    filter_faction2:name(), "data_defined_situation_war_proposer_to_recipient", false)
end
function chibi208:RemoveMission()
    -- Assuming player's keys,Selecting the first faction key,Passing faction key to modify_faction
    modify_filter_faction = cm:modify_faction(cm:get_human_factions()[1]);
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_kong_rong_destroy_yuan_shao");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_kong_rong_destroy_yuan_tan");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_liu_bei_destroy_lu_bu");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_liu_bei_destroy_yuan_shu");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_yuan_shao_destroy_faction");
    modify_filter_faction:cancel_custom_mission("3k_dlc04_main_tutorial_liu_chong_defeat_army_mission");
    modify_filter_faction:cancel_custom_mission("3k_dlc04_tutorial_liu_bei_defeat_army_mission");
    modify_filter_faction:cancel_custom_mission("3k_dlc04_tutorial_liu_bei_defeat_army_1_mission");
    modify_filter_faction:cancel_custom_mission("3k_dlc04_tutorial_liu_bei_defeat_army_2_mission");
    modify_filter_faction:cancel_custom_mission("3k_dlc04_tutorial_liu_bei_defeat_army_3_mission");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_gongsun_zan_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_kong_rong_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_liu_bei_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_liu_biao_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_zhang_yan_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_dlc05_tutorial_mission_zheng_jiang_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_cao_cao_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_dong_zhuo_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_gongsun_zan_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_kong_rong_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_liu_bei_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_liu_biao_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_ma_teng_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_sun_jian_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_tao_qian_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_yuan_shao_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_yuan_shu_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_zhang_yan_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_main_tutorial_mission_zheng_jiang_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_ytr_tutorial_mission_gong_du_1_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_ytr_tutorial_mission_he_yi_1_defeat_army");
    modify_filter_faction:cancel_custom_mission("3k_ytr_tutorial_mission_huang_shao_1_defeat_army");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_yue");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_ying");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_yong");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_lun");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_wei");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_jiong");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_ai");
    modify_filter_faction:cancel_custom_mission("ep_mission_introduction_destroy_army_sima_liang");

    modify_filter_faction:complete_custom_mission("3k_dlc04_main_tutorial_liu_chong_capture_settlement_mission");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_kong_rong_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_liu_bei_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_yan_baihu_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_zheng_jiang_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_cao_cao_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_dong_zhuo_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_gongsun_zan_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_kong_rong_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_liu_bei_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_liu_biao_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_ma_teng_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_sun_jian_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_tao_qian_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_yuan_shao_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_yuan_shu_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_zhang_yan_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_zheng_jiang_capture_settlement");
    modify_filter_faction:complete_custom_mission("3k_ytr_tutorial_mission_gong_du_1_capture_region");
    modify_filter_faction:complete_custom_mission("3k_ytr_tutorial_mission_huang_shao_1_capture_region");
    modify_filter_faction:complete_custom_mission("3k_ytr_tutorial_mission_he_yi_1_capture_region");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_liu_bei_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_yuan_shao_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_ma_teng_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_cao_cao_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_zhang_yan_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_liu_biao_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_dong_zhuo_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_sun_jian_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_yuan_shu_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_gongsun_zan_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_zheng_jiang_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_kong_rong_construct_building");
    modify_filter_faction:complete_custom_mission("3k_main_tutorial_mission_tao_qian_construct_building");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_ma_teng_construct_building");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_yan_baihu_construct_building");
    modify_filter_faction:complete_custom_mission("3k_dlc05_tutorial_mission_zheng_jiang_construct_building");
    modify_filter_faction:complete_custom_mission("3k_dlc06_progression_nanman_destroy_faction_mission");
end
